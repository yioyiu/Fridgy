name: iOS Submit to App Store

on:
  workflow_dispatch:
    inputs:
      build_id:
        description: 'Build ID to submit (leave empty to use latest production build)'
        required: false
        type: string
      submit_profile:
        description: 'Submit profile to use'
        required: false
        default: 'production'
        type: choice
        options:
          - production
      skip_binary_upload:
        description: 'Skip binary upload (only update metadata)'
        required: false
        default: false
        type: boolean
  workflow_run:
    workflows: ["iOS Build"]
    types:
      - completed
    branches:
      - master
      - main

permissions:
  contents: read

jobs:
  submit:
    name: Submit iOS App to App Store
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # Only run if the build workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci --silent

      - name: Setup Expo CLI
        run: |
          npm install -g @expo/cli@latest

      - name: Setup EAS CLI
        run: |
          npm install -g eas-cli@latest

      - name: Configure EAS
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          if [ -z "$EXPO_TOKEN" ]; then
            echo "::error::EXPO_TOKEN secret is required"
            exit 1
          fi
          echo "EAS configured successfully"

      - name: Submit to App Store
        id: submit
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          BUILD_ID="${{ github.event.inputs.build_id }}"
          SUBMIT_PROFILE="${{ github.event.inputs.submit_profile || 'production' }}"
          SKIP_BINARY="${{ github.event.inputs.skip_binary_upload || 'false' }}"
          
          echo "Submitting iOS app to App Store..."
          echo "Submit profile: $SUBMIT_PROFILE"
          
          # Build submit command
          SUBMIT_CMD="eas submit --platform ios --profile $SUBMIT_PROFILE --non-interactive"
          
          # Add build ID if specified
          if [ -n "$BUILD_ID" ] && [ "$BUILD_ID" != "" ]; then
            echo "Using specified build ID: $BUILD_ID"
            SUBMIT_CMD="$SUBMIT_CMD --latest"
          else
            echo "Using latest production build"
            SUBMIT_CMD="$SUBMIT_CMD --latest"
          fi
          
          # Add skip binary flag if needed
          if [ "$SKIP_BINARY" = "true" ]; then
            echo "Skipping binary upload (metadata only)"
            SUBMIT_CMD="$SUBMIT_CMD --skip-binary-upload"
          fi
          
          # Execute submit command
          set +e
          $SUBMIT_CMD --json > submit_output.json 2>&1
          SUBMIT_EXIT_CODE=$?
          set -e
          
          # Check if submit command succeeded
          if [ $SUBMIT_EXIT_CODE -ne 0 ]; then
            echo "::error::EAS submit command failed with exit code $SUBMIT_EXIT_CODE"
            if [ -f submit_output.json ]; then
              echo "Submit output:"
              cat submit_output.json
            fi
            exit 1
          fi
          
          # Extract submit ID
          SUBMIT_ID=$(cat submit_output.json | jq -r '.id // .[0].id // empty')
          if [ -z "$SUBMIT_ID" ] || [ "$SUBMIT_ID" = "null" ]; then
            echo "::warning::Could not extract submit ID, but submit may have succeeded"
            cat submit_output.json
          else
            echo "Submit ID: $SUBMIT_ID"
            echo "submit_id=$SUBMIT_ID" >> $GITHUB_OUTPUT
          fi

      - name: Submit summary
        if: success()
        run: |
          echo "## ðŸ“¤ iOS App Submitted to App Store" >> $GITHUB_STEP_SUMMARY
          echo "- **Submit Profile**: ${{ github.event.inputs.submit_profile || 'production' }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.submit.outputs.submit_id }}" ]; then
            echo "- **Submit ID**: ${{ steps.submit.outputs.submit_id }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your app has been submitted to App Store Connect. Check the status at:" >> $GITHUB_STEP_SUMMARY
          echo "https://appstoreconnect.apple.com/" >> $GITHUB_STEP_SUMMARY

